# è‡ªåŠ¨å‘å¸ƒæµæ°´çº¿
# å½“æŽ¨é€ v* æ ¼å¼çš„ Tag æ—¶ï¼Œè‡ªåŠ¨ç¼–è¯‘åŽç«¯ï¼ˆå¤šå¹³å°ï¼‰+ æ‰“åŒ…å‰ç«¯ï¼Œå‘å¸ƒåˆ° GitHub Releases
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æå–ç‰ˆæœ¬å·
        id: version
        run: |
          # ä»Ž tag ä¸­æå–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰ v å‰ç¼€ï¼‰
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: å®‰è£… Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: core/go.sum

      - name: å®‰è£… Node.js + pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£… pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: æž„å»ºå‰ç«¯
        working-directory: webapp
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: æ‰“åŒ…å‰ç«¯äº§ç‰©
        run: tar -czf webapp-dist.tar.gz -C webapp/dist .

      - name: æž„å»ºåŽç«¯ï¼ˆå¤šå¹³å°ï¼‰
        working-directory: core
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
          GIT_COMMIT: ${{ github.sha }}
        run: |
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          LDFLAGS="-s -w \
            -X your-finance/allfi/internal/version.Version=${APP_VERSION} \
            -X your-finance/allfi/internal/version.BuildTime=${BUILD_TIME} \
            -X your-finance/allfi/internal/version.GitCommit=${GIT_COMMIT}"

          # linux/amd64
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -ldflags="${LDFLAGS}" -o ../allfi-linux-amd64 cmd/server/main.go

          # linux/arm64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
            go build -ldflags="${LDFLAGS}" -o ../allfi-linux-arm64 cmd/server/main.go

          # darwin/amd64 (macOS Intel)
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 \
            go build -ldflags="${LDFLAGS}" -o ../allfi-darwin-amd64 cmd/server/main.go

          # darwin/arm64 (macOS Apple Silicon)
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 \
            go build -ldflags="${LDFLAGS}" -o ../allfi-darwin-arm64 cmd/server/main.go

      - name: æ‰“åŒ…å‘å¸ƒäº§ç‰©
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          # åŽç«¯äºŒè¿›åˆ¶ + é…ç½®æ–‡ä»¶ + å‰ç«¯äº§ç‰©
          for platform in linux-amd64 linux-arm64 darwin-amd64 darwin-arm64; do
            mkdir -p "allfi-${APP_VERSION}-${platform}"
            cp "allfi-${platform}" "allfi-${APP_VERSION}-${platform}/allfi"
            cp core/manifest/config/config.yaml "allfi-${APP_VERSION}-${platform}/"
            cp -r webapp/dist "allfi-${APP_VERSION}-${platform}/webapp-dist"
            tar -czf "allfi-${APP_VERSION}-${platform}.tar.gz" "allfi-${APP_VERSION}-${platform}"
          done

      - name: è¯»å– CHANGEHISTORY ç”Ÿæˆ Release Notes
        id: notes
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          # ç”Ÿæˆ release notesï¼šé¡¹ç›®ç®€ä»‹ + å½“å‰ç‰ˆæœ¬å˜æ›´è®°å½• + æ–‡æ¡£é“¾æŽ¥
          {
            echo "å…¨æ ˆåŠ å¯†èµ„äº§ç®¡ç†å¹³å° â€” èšåˆ CEXã€DeFiã€NFT ä¸Žä¼ ç»Ÿèµ„äº§"
            echo ""

            # ä»Ž CHANGEHISTORY.md æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´è®°å½•
            if [ -f CHANGEHISTORY.md ]; then
              # åŒ¹é…ç‰ˆæœ¬æ ‡é¢˜è¡Œåˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜è¡Œä¹‹é—´çš„å†…å®¹
              SECTION=$(awk "/^## v${APP_VERSION}/{found=1; next} /^## v[0-9]/{found=0} found" CHANGEHISTORY.md)
              if [ -n "$SECTION" ]; then
                echo "$SECTION"
              else
                echo "Release v${APP_VERSION}"
              fi
            else
              echo "Release v${APP_VERSION}"
            fi

            echo ""
            echo "---"
            echo ""
            echo "ðŸ“¥ **å®‰è£…**"
            echo ""
            echo "ä»Ž Assets ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…ï¼Œè§£åŽ‹åŽè¿è¡Œ \`./allfi\` å³å¯å¯åŠ¨ã€‚"
            echo ""
            echo "| å¹³å° | æ–‡ä»¶ |"
            echo "|------|------|"
            echo "| Linux x86_64 | \`allfi-${APP_VERSION}-linux-amd64.tar.gz\` |"
            echo "| Linux ARM64 | \`allfi-${APP_VERSION}-linux-arm64.tar.gz\` |"
            echo "| macOS Intel | \`allfi-${APP_VERSION}-darwin-amd64.tar.gz\` |"
            echo "| macOS Apple Silicon | \`allfi-${APP_VERSION}-darwin-arm64.tar.gz\` |"
            echo "| å‰ç«¯äº§ç‰© | \`webapp-dist.tar.gz\` |"
            echo ""
            echo "ðŸ“š **æ–‡æ¡£**"
            echo ""
            echo "- [å®Œæ•´å˜æ›´åŽ†å²](https://github.com/${REPO}/blob/master/CHANGEHISTORY.md)"
            echo "- [é¡¹ç›®è¯´æ˜Ž](https://github.com/${REPO}/blob/master/README.md)"
          } > release_notes.md

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: AllFi v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          files: |
            allfi-${{ steps.version.outputs.version }}-linux-amd64.tar.gz
            allfi-${{ steps.version.outputs.version }}-linux-arm64.tar.gz
            allfi-${{ steps.version.outputs.version }}-darwin-amd64.tar.gz
            allfi-${{ steps.version.outputs.version }}-darwin-arm64.tar.gz
            webapp-dist.tar.gz
