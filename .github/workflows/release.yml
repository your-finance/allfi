# è‡ªåŠ¨å‘å¸ƒæµæ°´çº¿
# å½“æ¨é€ v* æ ¼å¼çš„ Tag æ—¶ï¼š
# 1. è‡ªåŠ¨ä» git log ç”Ÿæˆå˜æ›´è®°å½•ï¼Œæ›´æ–° CHANGEHISTORY.md å¹¶æ¨é€åˆ° master
# 2. ç¼–è¯‘åç«¯ï¼ˆå¤šå¹³å°ï¼‰+ æ‰“åŒ…å‰ç«¯ï¼Œå‘å¸ƒåˆ° GitHub Releases
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äº git log
          ref: master      # æ£€å‡º master åˆ†æ”¯ä»¥ä¾¿åç»­æ¨é€

      - name: æå–ç‰ˆæœ¬å·
        id: version
        run: |
          # ä» tag ä¸­æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

          # è·å–ä¸Šä¸€ä¸ª tagï¼ˆæŒ‰ç‰ˆæœ¬æ’åºï¼‰
          PREV_TAG=$(git tag -l 'v*' --sort=-v:refname | grep -v "^${GITHUB_REF_NAME}$" | head -n1)
          echo "prev_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"

          echo "ğŸ“Œ å½“å‰ç‰ˆæœ¬: ${GITHUB_REF_NAME} (${VERSION})"
          echo "ğŸ“Œ ä¸Šä¸€ç‰ˆæœ¬: ${PREV_TAG:-æ— }"

      # ============================================================
      # é˜¶æ®µ 1ï¼šè‡ªåŠ¨æ›´æ–° CHANGEHISTORY.md
      # ============================================================
      - name: ç”Ÿæˆå˜æ›´è®°å½•
        id: changelog
        env:
          TAG: ${{ steps.version.outputs.tag }}
          PREV_TAG: ${{ steps.version.outputs.prev_tag }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # è·å– tag çš„æ—¥æœŸ
          TAG_DATE=$(git log -1 --format=%ai "${TAG}" | cut -d' ' -f1)

          # è·å– git log
          if [ -n "${PREV_TAG}" ]; then
            echo "ğŸ“ è·å– ${PREV_TAG}..${TAG} ä¹‹é—´çš„æäº¤è®°å½•"
            COMMITS=$(git log "${PREV_TAG}..${TAG}" --pretty=format:"%s" --no-merges)
          else
            echo "ğŸ“ è·å–æ‰€æœ‰æäº¤è®°å½•ï¼ˆé¦–æ¬¡å‘ç‰ˆï¼‰"
            COMMITS=$(git log "${TAG}" --pretty=format:"%s" --no-merges)
          fi

          # åˆ›å»ºå˜æ›´è®°å½•ä¸´æ—¶æ–‡ä»¶
          CHANGELOG_FILE=$(mktemp)

          {
            echo ""
            echo "## ${TAG}ï¼ˆ${TAG_DATE}ï¼‰"
            echo ""

            # åˆ†ç±»æ•´ç†æäº¤è®°å½•
            FEAT=""
            FIX=""
            REFACTOR=""
            DOCS=""
            BUILD=""
            OTHER=""

            while IFS= read -r line; do
              [ -z "$line" ] && continue
              case "$line" in
                feat:*|feat\(*|æ·»åŠ *|æ–°å¢*|å®ç°*|æ”¯æŒ*)
                  FEAT="${FEAT}\n- ${line}"
                  ;;
                fix:*|fix\(*|fix\ *|ä¿®å¤*|ä¿®æ­£*)
                  FIX="${FIX}\n- ${line}"
                  ;;
                refactor:*|refactor\(*|é‡æ„*)
                  REFACTOR="${REFACTOR}\n- ${line}"
                  ;;
                docs:*|docs\(*|æ–‡æ¡£*|update\ README*|update\ CLAUDE*)
                  DOCS="${DOCS}\n- ${line}"
                  ;;
                build:*|build\(*|ci:*|ci\(*|æ„å»º*|éƒ¨ç½²*)
                  BUILD="${BUILD}\n- ${line}"
                  ;;
                *)
                  OTHER="${OTHER}\n- ${line}"
                  ;;
              esac
            done <<< "$COMMITS"

            # è¾“å‡ºåˆ†ç±»åçš„å˜æ›´è®°å½•
            if [ -n "$FEAT" ]; then
              echo "### åŠŸèƒ½æ–°å¢"
              echo -e "$FEAT"
              echo ""
            fi

            if [ -n "$FIX" ]; then
              echo "### é—®é¢˜ä¿®å¤"
              echo -e "$FIX"
              echo ""
            fi

            if [ -n "$REFACTOR" ]; then
              echo "### é‡æ„ä¼˜åŒ–"
              echo -e "$REFACTOR"
              echo ""
            fi

            if [ -n "$DOCS" ]; then
              echo "### æ–‡æ¡£æ›´æ–°"
              echo -e "$DOCS"
              echo ""
            fi

            if [ -n "$BUILD" ]; then
              echo "### æ„å»ºä¸éƒ¨ç½²"
              echo -e "$BUILD"
              echo ""
            fi

            if [ -n "$OTHER" ]; then
              echo "### å…¶ä»–å˜æ›´"
              echo -e "$OTHER"
              echo ""
            fi

          } > "$CHANGELOG_FILE"

          echo "changelog_file=${CHANGELOG_FILE}" >> "$GITHUB_OUTPUT"

          echo "--- ç”Ÿæˆçš„å˜æ›´è®°å½• ---"
          cat "$CHANGELOG_FILE"

      - name: æ›´æ–° CHANGEHISTORY.md
        env:
          CHANGELOG_FILE: ${{ steps.changelog.outputs.changelog_file }}
        run: |
          if [ ! -f CHANGEHISTORY.md ]; then
            echo "# AllFi ç‰ˆæœ¬å†å²" > CHANGEHISTORY.md
            echo "" >> CHANGEHISTORY.md
            echo "> è¯¦ç»†è®°å½•æ¯ä¸ªç‰ˆæœ¬çš„å˜æ›´å†…å®¹ã€‚ç‰ˆæœ¬å·ä¸æ ¹ç›®å½• \`VERSION\` æ–‡ä»¶å’Œ Git Tag ä¿æŒä¸€è‡´ã€‚" >> CHANGEHISTORY.md
            echo "" >> CHANGEHISTORY.md
            echo "---" >> CHANGEHISTORY.md
          fi

          # åœ¨ç¬¬ä¸€ä¸ª "## v" ä¹‹å‰æ’å…¥æ–°ç‰ˆæœ¬çš„å˜æ›´è®°å½•
          if grep -q "^## v" CHANGEHISTORY.md; then
            FIRST_VERSION_LINE=$(grep -n "^## v" CHANGEHISTORY.md | head -1 | cut -d: -f1)
            head -n $((FIRST_VERSION_LINE - 1)) CHANGEHISTORY.md > CHANGEHISTORY_new.md
            cat "$CHANGELOG_FILE" >> CHANGEHISTORY_new.md
            tail -n +${FIRST_VERSION_LINE} CHANGEHISTORY.md >> CHANGEHISTORY_new.md
            mv CHANGEHISTORY_new.md CHANGEHISTORY.md
          else
            cat "$CHANGELOG_FILE" >> CHANGEHISTORY.md
          fi

          echo "--- æ›´æ–°åçš„ CHANGEHISTORY.mdï¼ˆå‰ 50 è¡Œï¼‰---"
          head -50 CHANGEHISTORY.md

      - name: æäº¤ CHANGEHISTORY.md åˆ° master
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGEHISTORY.md
          if git diff --cached --quiet; then
            echo "â„¹ï¸ CHANGEHISTORY.md æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "docs: è‡ªåŠ¨æ›´æ–° CHANGEHISTORY.md â€” ${GITHUB_REF_NAME}"
            git push origin master
            echo "âœ… CHANGEHISTORY.md å·²æ›´æ–°å¹¶æ¨é€åˆ° master"
          fi

      # ============================================================
      # é˜¶æ®µ 2ï¼šæ„å»ºä¸å‘å¸ƒ
      # ============================================================
      - name: å®‰è£… Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: core/go.sum

      - name: å®‰è£… Node.js + pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£… pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: æ„å»ºå‰ç«¯
        working-directory: webapp
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: æ‰“åŒ…å‰ç«¯äº§ç‰©
        run: tar -czf webapp-dist.tar.gz -C webapp/dist .

      - name: å¤åˆ¶å‰ç«¯äº§ç‰©åˆ°åç«¯åµŒå…¥ç›®å½•
        run: cp -r webapp/dist core/internal/statics/dist

      - name: æ„å»ºåç«¯ï¼ˆå¤šå¹³å°ï¼‰
        working-directory: core
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
          GIT_COMMIT: ${{ github.sha }}
        run: |
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          LDFLAGS="-s -w \
            -X your-finance/allfi/internal/version.Version=${APP_VERSION} \
            -X your-finance/allfi/internal/version.BuildTime=${BUILD_TIME} \
            -X your-finance/allfi/internal/version.GitCommit=${GIT_COMMIT}"

          # linux/amd64
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -ldflags="${LDFLAGS}" -o ../allfi-linux-amd64 cmd/server/main.go

          # linux/arm64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
            go build -ldflags="${LDFLAGS}" -o ../allfi-linux-arm64 cmd/server/main.go

          # darwin/amd64 (macOS Intel)
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 \
            go build -ldflags="${LDFLAGS}" -o ../allfi-darwin-amd64 cmd/server/main.go

          # darwin/arm64 (macOS Apple Silicon)
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 \
            go build -ldflags="${LDFLAGS}" -o ../allfi-darwin-arm64 cmd/server/main.go

      - name: æ‰“åŒ…å‘å¸ƒäº§ç‰©
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          # åç«¯äºŒè¿›åˆ¶ + é…ç½®æ–‡ä»¶ + å‰ç«¯äº§ç‰©
          for platform in linux-amd64 linux-arm64 darwin-amd64 darwin-arm64; do
            mkdir -p "allfi-${APP_VERSION}-${platform}"
            cp "allfi-${platform}" "allfi-${APP_VERSION}-${platform}/allfi"
            cp core/manifest/config/config.yaml "allfi-${APP_VERSION}-${platform}/"
            cp -r webapp/dist "allfi-${APP_VERSION}-${platform}/webapp-dist"
            tar -czf "allfi-${APP_VERSION}-${platform}.tar.gz" "allfi-${APP_VERSION}-${platform}"
          done

      - name: è¯»å– CHANGEHISTORY ç”Ÿæˆ Release Notes
        id: notes
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          # ç”Ÿæˆ release notesï¼šé¡¹ç›®ç®€ä»‹ + å½“å‰ç‰ˆæœ¬å˜æ›´è®°å½• + æ–‡æ¡£é“¾æ¥
          {
            echo "å…¨æ ˆåŠ å¯†èµ„äº§ç®¡ç†å¹³å° â€” èšåˆ CEXã€DeFiã€NFT ä¸ä¼ ç»Ÿèµ„äº§"
            echo ""

            # ä»æ›´æ–°åçš„ CHANGEHISTORY.md æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´è®°å½•
            if [ -f CHANGEHISTORY.md ]; then
              SECTION=$(awk "/^## v${APP_VERSION}/{found=1; next} /^## v[0-9]/{found=0} found" CHANGEHISTORY.md)
              if [ -n "$SECTION" ]; then
                echo "$SECTION"
              else
                echo "Release v${APP_VERSION}"
              fi
            else
              echo "Release v${APP_VERSION}"
            fi

            echo ""
            echo "---"
            echo ""
            echo "ğŸ“¥ **å®‰è£…**"
            echo ""
            echo "ä» Assets ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…ï¼Œè§£å‹åè¿è¡Œ \`./allfi\` å³å¯å¯åŠ¨ã€‚"
            echo ""
            echo "| å¹³å° | æ–‡ä»¶ |"
            echo "|------|------|"
            echo "| Linux x86_64 | \`allfi-${APP_VERSION}-linux-amd64.tar.gz\` |"
            echo "| Linux ARM64 | \`allfi-${APP_VERSION}-linux-arm64.tar.gz\` |"
            echo "| macOS Intel | \`allfi-${APP_VERSION}-darwin-amd64.tar.gz\` |"
            echo "| macOS Apple Silicon | \`allfi-${APP_VERSION}-darwin-arm64.tar.gz\` |"
            echo "| å‰ç«¯äº§ç‰© | \`webapp-dist.tar.gz\` |"
            echo ""
            echo "ğŸ“š **æ–‡æ¡£**"
            echo ""
            echo "- [å®Œæ•´å˜æ›´å†å²](https://github.com/${REPO}/blob/master/CHANGEHISTORY.md)"
            echo "- [é¡¹ç›®è¯´æ˜](https://github.com/${REPO}/blob/master/README.md)"
          } > release_notes.md

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: AllFi v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          files: |
            allfi-${{ steps.version.outputs.version }}-linux-amd64.tar.gz
            allfi-${{ steps.version.outputs.version }}-linux-arm64.tar.gz
            allfi-${{ steps.version.outputs.version }}-darwin-amd64.tar.gz
            allfi-${{ steps.version.outputs.version }}-darwin-arm64.tar.gz
            webapp-dist.tar.gz
