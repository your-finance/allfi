# AllFi Docker Compose 编排
# 用法: cp .env.example .env && docker-compose up -d

services:
  backend:
    # 使用本地构建的镜像（避免 Docker OOM）
    # 如需重新构建，运行: bash deploy/build-local.sh
    image: allfi-backend:latest
    # build 配置保留，如需使用 Docker 构建可取消注释并注释掉 image:
    # build:
    #   context: .
    #   dockerfile: core/Dockerfile
    #   args:
    #     APP_VERSION: "${ALLFI_VERSION:-0.3.0}"
    #     BUILD_TIME: "${BUILD_TIME:-unknown}"
    #     GIT_COMMIT: "${GIT_COMMIT:-unknown}"
    #   shm_size: 2gb
    container_name: allfi-backend
    restart: unless-stopped
    ports:
      # 统一端口：前端静态文件 + 后端 API 均通过此端口访问
      - "${ALLFI_PORT:-5173}:8080"
    volumes:
      - allfi-data:/app/data
      # 时区配置：挂载宿主机时区文件，确保容器时区与宿主机一致
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      # 时区配置（可在 .env 中自定义，默认使用宿主机时区）
      - TZ=${TZ:-Asia/Shanghai}
      - ALLFI_MASTER_KEY=${ALLFI_MASTER_KEY}
      - ETHERSCAN_API_KEY=${ETHERSCAN_API_KEY}
      - BSCSCAN_API_KEY=${BSCSCAN_API_KEY}
      - COINGECKO_API_KEY=${COINGECKO_API_KEY}
      # 代理配置（可选，国内用户在 .env 中启用）
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:uid=100,gid=101
      - /app/logs:uid=100,gid=101
    mem_limit: 512m
    memswap_limit: 512m
    healthcheck:
      test: [ "CMD", "wget", "-qO", "/dev/null", "http://localhost:8080/api/v1/health" ]
      interval: 30s
      timeout: 5s
      retries: 3

  updater:
    build: ./updater
    container_name: allfi-updater
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/app/project
      - allfi-data:/app/data
      # 时区配置：挂载宿主机时区文件
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      # 时区配置（与 backend 保持一致）
      - TZ=${TZ:-Asia/Shanghai}
    working_dir: /app/project

volumes:
  allfi-data:
    driver: local
